# 静的解析レポート

実施日: 2025年12月3日

## 実施内容

### 1. Lint (Clippy)
- **ステータス**: ✅ 全て解決
- **検出された問題**: 11件
  - `needless_borrow`: 10件 - 不要な参照の削除
  - `doc_lazy_continuation`: 1件 - ドキュメントコメントのインデント修正
- **対応**: 全ての警告を修正し、`cargo clippy --all-targets -- -D warnings` が成功

### 2. コード品質
- **cargo fmt**: ✅ 通過（全ファイルがフォーマット済み）
- **cargo doc**: ✅ 警告解決
  - rustdoc HTML タグ警告2件を修正（`Option<Int>`, `List<Str>`, `Result` 型）
  - バッククォートでエスケープ処理

### 3. 未使用依存関係チェック (cargo-udeps)
- **ステータス**: ✅ 問題なし
- **結果**: "All deps seem to have been used."
- 全ての依存関係が適切に使用されている

### 4. ドキュメントリンクチェック (cargo-deadlinks)
- **ステータス**: ✅ 問題なし
- ドキュメント内のリンク切れなし

### 5. テストカバレッジ
- **総テスト数**: 113件
  - lzscr-cli: 30件
  - lzscr-types: 23件
  - lzscr-runtime: 15件
  - lzscr-lexer: 11件
  - lzscr-parser: 10件
  - その他: 24件
- **成功率**: 100% (113 passed, 0 failed)
- **無視**: 8件（ドキュメントテスト）

### 6. バイナリサイズ分析 (cargo-bloat)
最大の関数（リリースビルド）:
1. `lzscr_types::inference::expr::infer_expr` - 48.7KiB (2.7%)
2. `lzscr_cli::main` - 48.3KiB (2.6%)
3. `<lzscr_cli::Opt as clap_builder::derive::Args>::augment_args` - 47.3KiB (2.6%)

## 検出された問題点

### 複雑度の問題
1. **main関数が巨大** (1114行)
   - 位置: `crates/lzscr-cli/src/main.rs:515-1628`
   - 問題: 単一関数に多くのロジックが集中
   - 推奨: リファクタリングして複数の関数に分割

2. **Env::with_builtins が巨大** (276行)
   - 位置: `crates/lzscr-runtime/src/lib.rs:70-346`
   - 問題: ビルトイン関数の定義が単一関数に集中
   - 推奨: カテゴリごとにモジュール分割（既に実装済み？）

3. **繰り返しパターン**
   - `eprintln!`: 132回の呼び出し（main.rs内）
   - `format_span_block`: 41回の呼び出し
   - `normalize_span`: 13回の呼び出し
   - 推奨: エラー表示のヘルパー関数を導入

### Code Clone Detection
主なクローンパターン:
- エラー表示ロジック（型エラー、スパン表示、ヒント出力）が繰り返し
- スパン正規化 + フォーマットのパターンが多数

## 推奨される改善

### 優先度: 高
1. **main関数のリファクタリング**
   - エラー表示ロジックを専用関数に抽出
   - サブコマンドごとにモジュール分割を検討

2. **エラー表示の統一**
   - `DisplayError` トレイト/ヘルパー関数の導入
   - スパン表示とヒント出力の共通化

### 優先度: 中
3. **複雑度メトリクスの導入**
   - CI に `cargo-complexity` や類似ツールを追加
   - 複雑度閾値を設定

4. **デッドコード検出の定期実行**
   - CI で `#[warn(dead_code)]` を有効化

### 優先度: 低
5. **ドキュメントカバレッジの向上**
   - 公開APIの全関数にドキュメントコメントを追加
   - 使用例の充実

## まとめ

### ✅ 良好な点
- 依存関係管理が適切
- テストカバレッジが高い（113テスト、100%成功）
- Lint/フォーマットの警告が解消済み
- unsafe コードの使用なし（cargo-geiger 未実施だが、コードレビューから推測）

### ⚠️ 改善点
- main関数の複雑度が高い（1114行）
- コードクローンが一部存在（エラー表示ロジック）
- 関数の複雑度が一部高い（特に型推論とパース）

### 次のステップ
1. main関数のリファクタリング（複雑度低減）
2. エラー表示の統一化（コードクローン削減）
3. CI への静的解析ツール統合
