# Copilot Instructions: Phase 5 - Record Field Spans

## ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: Refactoring

**ãƒ•ã‚©ãƒ¼ã‚«ã‚¹**: AST Refactoring, Phase 5 Record Field Spans, PatternKind::Record Implementation  
**å„ªå…ˆåº¦**: High  
**ãƒ¢ãƒ¼ãƒ‰**: Normal (æ®µéšçš„å®Ÿè£…)

---

## ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯: Step 7 - PatternRecordField Implementation

### èƒŒæ™¯
- **Phase 5ç›®æ¨™**: ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®æ­£ç¢ºãªã‚¹ãƒ‘ãƒ³è¿½è·¡ã«ã‚ˆã‚‹è¨ºæ–­ç²¾åº¦å‘ä¸Š
- **Step 1-6å®Œäº†**: ExprKind::Record âœ… (ã‚³ãƒŸãƒƒãƒˆ: 526024f)
  - ExprRecordFieldæ§‹é€ ä½“è¿½åŠ 
  - ãƒ‘ãƒ¼ã‚µãƒ¼ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¹ãƒ‘ãƒ³å–å¾—
  - å‹ãƒã‚§ãƒƒã‚«ãƒ¼ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¹ãƒ‘ãƒ³ã‚’ä½¿ç”¨
  - å…¨7ã‚¯ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã€å…¨113ãƒ†ã‚¹ãƒˆæˆåŠŸ
- **æ¬¡**: PatternKind::Record ã‚’åŒæ§˜ã«æ›´æ–°

### Step 7 å®Ÿè£…æ‰‹é †

**ç›®æ¨™**: PatternKind::Record ã‚’ ExprKind::Record ã¨åŒæ§˜ã«æ›´æ–°

#### 1. PatternRecordField æ§‹é€ ä½“ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/lzscr-ast/src/lib.rs`

ExprRecordField ã®ç›´å¾Œã«è¿½åŠ :

```rust
/// Record field in a pattern with field name span tracking.
/// Phase 5: Diagnostics Improvement - enables precise error reporting for pattern record fields.
#[derive(Debug, Clone, PartialEq)]
pub struct PatternRecordField {
    pub name: String,
    pub name_span: Span,
    pub pattern: Pattern,
}

impl PatternRecordField {
    pub fn new(name: String, name_span: Span, pattern: Pattern) -> Self {
        Self { name, name_span, pattern }
    }
}
```

#### 2. PatternKind::Record å®šç¾©ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/lzscr-ast/src/lib.rs`

```rust
// å¤‰æ›´å‰:
Record(Vec<(String, Pattern)>),

// å¤‰æ›´å¾Œ:
Record(Vec<PatternRecordField>),
```

#### 3. ãƒ‘ãƒ¼ã‚µãƒ¼æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `crates/lzscr-parser/src/lib.rs` (pattern parsing section)

ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ‘ãƒ¼ã‚¹ç®‡æ‰€ï¼ˆç´„2000è¡Œä»˜è¿‘ï¼‰ã‚’æ›´æ–°ã—ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¹ãƒ‘ãƒ³ã‚’å–å¾—:

```rust
// key_span ã‚’ä¿å­˜ã—ã¦ PatternRecordField ã‚’æ§‹ç¯‰
let key_span = ktok.span;
fields.push(PatternRecordField::new(key, key_span, pattern));
```

#### 4. å½±éŸ¿ç¯„å›²ã®æ›´æ–°

ä»¥ä¸‹ã®ã‚¯ãƒ¬ãƒ¼ãƒˆã§ `PatternKind::Record` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’æ›´æ–°:

- **lzscr-analyzer/src/lib.rs**: 
  - `hash_pattern_shape()` é–¢æ•°
  - `collect_vars()` é–¢æ•°ï¼ˆè¤‡æ•°ç®‡æ‰€ï¼‰
  - `pat_idents()` é–¢æ•°ï¼ˆè¤‡æ•°ç®‡æ‰€ï¼‰
  - `binds_param()` é–¢æ•°
  - `binds_name()` é–¢æ•°

- **lzscr-cli/src/main.rs**:
  - `rebase_pattern_with_minus()` é–¢æ•°

- **lzscr-types/src/inference/pattern.rs**:
  - ãƒ‘ã‚¿ãƒ¼ãƒ³å‹æ¨è«–ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´**: `for (k, v) in fields` â†’ `for f in fields` with `f.name`, `f.name_span`, `&f.pattern`

#### 5. ãƒ†ã‚¹ãƒˆã¨ã‚³ãƒŸãƒƒãƒˆ

```bash
# ãƒ“ãƒ«ãƒ‰ç¢ºèª
cargo build

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cargo test

# ã‚³ãƒŸãƒƒãƒˆ
git add -A
git commit -m "feat(diagnostics): Phase 5 Step 7 - Add field name spans to PatternKind::Record

- Added PatternRecordField struct with name, name_span, pattern fields
- Updated PatternKind::Record to use Vec<PatternRecordField>
- Parser captures pattern field name spans
- Updated lzscr-analyzer, lzscr-cli, lzscr-types
- All tests passing
- Enables precise error reporting for pattern record fields"
```

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’æ­£ç¢ºã«æŒ‡æ‘˜å¯èƒ½
- ExprKind::Record ã¨ä¸€è²«æ€§ã®ã‚ã‚‹æ§‹é€ 
- ç´„25-30ç®‡æ‰€ã®æ›´æ–°ï¼ˆExprã‚ˆã‚Šå°‘ãªã„ï¼‰

### æ³¨æ„ç‚¹
- ExprRecordField ã¨åŒã˜æ§‹é€ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
- `PatternRecordField` ã¯ `#[derive(PartialEq)]` ãŒå¿…è¦ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§ä½¿ç”¨ï¼‰
- å‹æ¨è«–ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¹ãƒ‘ãƒ³ã‚’ä¿å­˜

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆStep 7 å®Œäº†å¾Œï¼‰

### Step 8: TypeExprRecordField Implementation
- TypeExpr::Record ã‚’åŒæ§˜ã«æ›´æ–°
- æ¨å®šä½œæ¥­é‡: 30-45åˆ†ï¼ˆæœ€å°ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
- æ–°æ§‹é€ ä½“: `TypeExprRecordField { name: String, name_span: Span, type_expr: TypeExpr }`

### Step 9: Error Display Improvements
- TypeError è¡¨ç¤ºã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚¹ãƒ‘ãƒ³ã‚’æ´»ç”¨
- `display_type_error_diagnostic()` æ›´æ–°
- ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ†ã‚¹ãƒˆè¿½åŠ 
- ä¾‹: "Missing field 'age'" ãŒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’æ­£ç¢ºã«æŒ‡æ‘˜

---

## Phase 5 å…¨ä½“é€²æ—

- âœ… Step 1-6: ExprKind::Record (å®Œäº†)
- ğŸ”„ Step 7: PatternKind::Record (é€²è¡Œä¸­)
- â³ Step 8: TypeExpr::Record (æœªç€æ‰‹)
- â³ Step 9: Error Display (æœªç€æ‰‹)

é€²æ—: 33% â†’ 66% (Step 7å®Œäº†æ™‚) â†’ 100% (Phase 5å®Œäº†æ™‚)

---

## å‚è€ƒæƒ…å ±
- Phase 5 ã‚³ãƒŸãƒƒãƒˆ: `526024f` (ExprKind::Recordå®Œäº†)
- è¨ºæ–­æ”¹å–„è¨ˆç”»: `docs/diagnostics-improvement-plan.md`
- æ¬¡ãƒ•ã‚§ãƒ¼ã‚º: Phase 6 (Error Message Style Guide)
